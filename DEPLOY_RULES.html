<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deploy Firebase Rules</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a2e;
            color: #fff;
        }
        .container {
            background: #16213e;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        h1 {
            color: #4ecca3;
            text-align: center;
        }
        .step {
            background: #0f3460;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #4ecca3;
        }
        .step h2 {
            color: #4ecca3;
            margin-top: 0;
        }
        button {
            background: #4ecca3;
            color: #1a1a2e;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
        }
        button:hover {
            background: #3fb98f;
        }
        .code-box {
            background: #000;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 15px 0;
            position: relative;
        }
        .code-box pre {
            margin: 0;
            color: #4ecca3;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4ecca3;
            color: #000;
            border: none;
            padding: 5px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .warning {
            background: #ff6b6b;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
        }
        .success {
            background: #51cf66;
            color: #000;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Deploy Firebase Rules</h1>
        
        <div class="warning">
            ‚ö†Ô∏è Your OTP verification is failing because Firebase rules are NOT deployed!
        </div>

        <div class="step">
            <h2>Step 1: Copy the Rules</h2>
            <p>Click the button below to copy the rules to your clipboard:</p>
            <button onclick="copyRules()">üìã Copy Rules to Clipboard</button>
            <p id="copy-status" style="text-align: center; margin-top: 10px;"></p>
        </div>

        <div class="step">
            <h2>Step 2: Open Firebase Console</h2>
            <p>Click the button below to open Firebase Console in a new tab:</p>
            <button onclick="openFirebase()">üöÄ Open Firebase Rules Page</button>
        </div>

        <div class="step">
            <h2>Step 3: Paste and Publish</h2>
            <ol>
                <li>In the Firebase Console, press <strong>Ctrl+A</strong> to select all</li>
                <li>Press <strong>Delete</strong> to clear old rules</li>
                <li>Press <strong>Ctrl+V</strong> to paste new rules</li>
                <li>Click the blue <strong>"Publish"</strong> button</li>
                <li>Wait 30 seconds</li>
            </ol>
        </div>

        <div class="step">
            <h2>Step 4: Test</h2>
            <ol>
                <li>Refresh your app (Ctrl+Shift+R)</li>
                <li>Register with a new email</li>
                <li>Enter OTP from your email</li>
                <li>‚úÖ Should work!</li>
            </ol>
        </div>

        <div class="success" id="success-msg" style="display: none;">
            ‚úÖ Rules copied! Now go to Firebase Console and paste them!
        </div>

        <div class="code-box">
            <button class="copy-btn" onclick="copyRules()">Copy</button>
            <pre id="rules-code">rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if (request.auth == null || request.auth.uid == userId);
      allow update: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null 
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['pendingRequests'])
        && request.resource.data.pendingRequests.size() >= resource.data.pendingRequests.size();
      allow update: if request.auth != null 
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['partner'])
        && request.resource.data.partner == request.auth.uid;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
      allow update: if request.auth != null 
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'comments']);
    }
    
    match /messages/{messageId} {
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.senderId || 
         request.auth.uid == resource.data.receiverId);
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.senderId;
      allow update: if request.auth != null && request.auth.uid == resource.data.senderId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.senderId;
    }
    
    match /notes/{noteId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.partner == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    match /otpCodes/{userId} {
      allow read: if true;
      allow write: if true;
    }
  }
}</pre>
        </div>
    </div>

    <script>
        const rules = `rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if (request.auth == null || request.auth.uid == userId);
      allow update: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null 
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['pendingRequests'])
        && request.resource.data.pendingRequests.size() >= resource.data.pendingRequests.size();
      allow update: if request.auth != null 
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['partner'])
        && request.resource.data.partner == request.auth.uid;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }
    
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.userId;
      allow update: if request.auth != null 
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['likes', 'comments']);
    }
    
    match /messages/{messageId} {
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.senderId || 
         request.auth.uid == resource.data.receiverId);
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.senderId;
      allow update: if request.auth != null && request.auth.uid == resource.data.senderId;
      allow delete: if request.auth != null && request.auth.uid == resource.data.senderId;
    }
    
    match /notes/{noteId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.partner == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    match /otpCodes/{userId} {
      allow read: if true;
      allow write: if true;
    }
  }
}`;

        function copyRules() {
            navigator.clipboard.writeText(rules).then(() => {
                document.getElementById('copy-status').textContent = '‚úÖ Copied to clipboard!';
                document.getElementById('success-msg').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('copy-status').textContent = '';
                }, 3000);
            }).catch(err => {
                alert('Failed to copy. Please copy manually from the box below.');
            });
        }

        function openFirebase() {
            window.open('https://console.firebase.google.com/project/partner-b4e79/firestore/rules', '_blank');
        }
    </script>
</body>
</html>
